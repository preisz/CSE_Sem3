<?xml version="1.0"?>
<cfsSimulation xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.cfs++.org/simulation https://opencfs.gitlab.io/cfs/xml/CFS-Simulation/CFS.xsd"
 xmlns="http://www.cfs++.org/simulation">
 
  
 <documentation>
   <title> Piezolectricity, Homework 2</title>
   <authors>
     <author> Petra Reisz </author>
   </authors>
   <date>2023-11-29</date>
   <keywords>
     <keyword>electrostatic-mechanic</keyword>
   </keywords>
   <references> no references </references>
   <isVerified>no</isVerified>
   <description>
   Description of the simulation
   </description>
 </documentation>

  <fileFormats>
    <input >
      <cdb fileName="geomHW2.cdb"/>
    </input >
    <output>
      <hdf5/>
      <text id='txt'/>
    </output>
    <materialData file="./mat_eff.xml" format="xml"/>
  </fileFormats>

  <domain geometryType="3d">
    <regionList>
      <region name="Plate_PMMA" material="PMMA">
        <matRotation alpha="0.0" beta="0" gamma="0"/>
      </region>
      <region name="Patch1" material="PIC 255">
        <matRotation alpha="0.0" beta="0" gamma="0"/>
      </region>
      <region name="Patch2" material="PIC 255">
        <matRotation alpha="0.0" beta="0" gamma="0"/>
      </region>
      <region name="Patch3" material="PIC 255">
        <matRotation alpha="0.0" beta="0" gamma="0"/>
      </region>
    </regionList>
    <nodeList> <!-- CFS can pick nodes from the mesh, e.g. to write text output for this point -->
      <nodes name="P_middle">
          <coord x="0.0" y="0" z="0"/> <!-- this should be the middle of plate, CFS will search for the closest node -->
      </nodes>
  </nodeList>
  </domain> 
  
  <!-- Static Analysis in sequenceStep 1-->
  <sequenceStep index="1">
    <analysis>
      <static/>
    </analysis>

    <pdeList>
      <!-- Mechanic PDE: on the plate. -->
      <mechanic subType="3d">
        <regionList>
          <region name="Plate_PMMA"/>
          <region name="Patch1" />
          <region name="Patch2" />
          <region name="Patch3" />
          </regionList>
          <bcsAndLoads>
            <fix name="Gamma_s1">
              <comp dof="x"/>
              <comp dof="y"/>
              <comp dof="z"/>
            </fix>
            <fix name="Gamma_s2">
              <comp dof="x"/>
              <comp dof="y"/>
              <comp dof="z"/>
            </fix>
            <fix name="Gamma_s3">
              <comp dof="x"/>
              <comp dof="y"/>
              <comp dof="z"/>
            </fix>
            <fix name="Gamma_s4">
                <comp dof="x"/>
                <comp dof="y"/>
                <comp dof="z"/>
            </fix>
          <pressure
              name="Gamma_down" value="1000"> <!-- Uniform pressure on bottom of plate-->
          </pressure>
        </bcsAndLoads>

        <storeResults>
          <nodeResult type="mechDisplacement">
            <regionList>
              <region name="Plate_PMMA" />
            </regionList>
          </nodeResult>
        </storeResults>
      </mechanic>

      <!--  #################Electrostatic, pathes-->
      <electrostatic>
        <regionList>
          <region name="Patch1"/>
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>
        <bcsAndLoads>
          <constraint name="Patch3_Sdown"></constraint>
          <constraint name="Patch1_Sdown"></constraint>
          <constraint name="Patch2_Sdown"></constraint>

          <potential name="Patch1_Sup" value="500"/> <!-- 500 V potential applied on the top-->
          <potential name="Patch2_Sup" value="500"/>
          <potential name="Patch3_Sup" value="500"/>
        </bcsAndLoads>
        <storeResults>
          <nodeResult type="elecPotential">
            <allRegions/>
          </nodeResult>
          <elemResult type="elecFieldIntensity">
            <allRegions/>
          </elemResult>
        </storeResults>
      </electrostatic>
    </pdeList>

    <!-- Piezo Couplling##########################-->
    <couplingList>
      <direct>
        <piezoDirect>
          <regionList>
            <!-- Regions for piezo coupling: patches-->
            <region name="Patch1"/>
            <region name="Patch2" />
            <region name="Patch3" />  
          </regionList>
        </piezoDirect>
      </direct>
    </couplingList>
  </sequenceStep>

<!-- #####################Eigenvalue Analysis in sequenceStep 2 -->
  <sequenceStep index="2">
    <analysis>
      <eigenFrequency>
        <isQuadratic>no</isQuadratic>
        <numModes> 10 </numModes>
        <freqShift>0</freqShift>
        <writeModes>yes</writeModes>
      </eigenFrequency>
    </analysis>

    <pdeList>
      <!-- Mechanic PDE -->
      <mechanic subType="3d">
        <regionList>
          <region name="Plate_PMMA"/>
          <region name="Patch1" />
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>
        <bcsAndLoads>
          <!-- Boundary conditions for mechanic PDE -->
          <fix name="Gamma_s1">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s2">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s3">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s4">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
        </bcsAndLoads>
        <storeResults>
          <nodeResult type="mechDisplacement">
            <regionList>
              <region name="Plate_PMMA" />
            </regionList>
          </nodeResult>
        </storeResults>
      </mechanic>

      <electrostatic>
        <regionList> <!-- Same as for static-->
          <region name="Patch1"/> 
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>
        <bcsAndLoads>
          <constraint name="Patch1_Sdown" /> <!-- Same Potential all over the electrodes-->
          <constraint name="Patch2_Sdown" />
          <constraint name="Patch3_Sdown" />
  
          <constraint name="Patch1_Sup" /> 
          <constraint name="Patch2_Sup" />
          <constraint name="Patch3_Sup" />
        </bcsAndLoads>
       
        <storeResults>
            <nodeResult type="elecPotential">
              <allRegions/>
            </nodeResult>
        </storeResults>
      </electrostatic>
    </pdeList>

    <couplingList>
      <direct>
        <piezoDirect>
          <regionList>
            <region name="Patch1"/> 
            <region name="Patch2" />
            <region name="Patch3" />
          </regionList>
        </piezoDirect>
      </direct>
    </couplingList>
  </sequenceStep>

  <!-- Harmonic Analysis in sequenceStep 3-->
  <sequenceStep index="3">
    <analysis>
      <harmonic>
        <numFreq> 10 </numFreq>
        <startFreq> 1 </startFreq>
        <stopFreq> 500 </stopFreq>  <!-- Up to 500Hz -->
      </harmonic>
    </analysis>

    <pdeList>
      <!-- Mechanic PDE -->
      <mechanic subType="3d">
        <regionList>
          <region name="Plate_PMMA"/>
          <region name="Patch1" />
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>
        <bcsAndLoads>
          <fix name="Gamma_s1">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s2">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s3">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s4">
              <comp dof="x"/>
              <comp dof="y"/>
              <comp dof="z"/>
          </fix>
          <pressure name="Gamma_down" value="1000"/> 
         <!--<pressure name="Gamma_down" value="1000*sin(2*pi*1*t)"/> -->  <!-- Harmonic pressure on bottom-->
        </bcsAndLoads>
        <storeResults>
          <nodeResult type="mechDisplacement">
            <nodeList>
                <nodes name="P_middle"/> <!-- need to make this-->
            </nodeList>
        </nodeResult>
        </storeResults>
      </mechanic>

      <electrostatic>
        <regionList>
          <region name="Patch1"/>
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>
        <bcsAndLoads>
          <constraint name="Patch1_Sdown" /> <!-- Same Potential all over the electrodes-->
          <constraint name="Patch2_Sdown" />
          <constraint name="Patch3_Sdown" />
  
          <constraint name="Patch1_Sup" /> 
          <constraint name="Patch2_Sup" />
          <constraint name="Patch3_Sup" />
       </bcsAndLoads>
        <storeResults>
          <nodeResult type="elecPotential">
            <regionList>
              <region name="Patch1_Sdown" />
              <region name="Patch1_Sup" />
              <region name="Patch2_Sdown" />
              <region name="Patch2_Sup" />  
              <region name="Patch1_Sdown" />
              <region name="Patch1_Sup" />
            </regionList>
          </nodeResult>
        </storeResults>
      </electrostatic>
    </pdeList>

    <couplingList>
      <direct>
        <piezoDirect>
          <regionList>
            <!-- Regions for piezo coupling-->
            <region name="Patch1"/>
            <region name="Patch2" />
            <region name="Patch3" />
          </regionList>
        </piezoDirect>
      </direct>
    </couplingList>
  </sequenceStep>

  <!-- Harmonic analysis: Instead of harmonic pressure, apply a harmonic voltage of 500V on patch 3 and compute the
transfer function (up to 500Hz) for the voltage at patches 1 and 2. Plot the transfer functions-->
<sequenceStep index="4">
  <analysis>
    <harmonic>
      <numFreq> 10 </numFreq>
      <startFreq> 1 </startFreq>
      <stopFreq> 500 </stopFreq>  <!-- Up to 500Hz -->
    </harmonic>
  </analysis>

  <pdeList>
    <!-- Mechanic PDE -->
    <mechanic subType="3d">
      <regionList>
        <region name="PMMA_Plate"/>
      </regionList>
      <bcsAndLoads>
        <fix name="Gamma_s1">
          <comp dof="x"/>
          <comp dof="y"/>
          <comp dof="z"/>
        </fix>
        <fix name="Gamma_s2">
          <comp dof="x"/>
          <comp dof="y"/>
          <comp dof="z"/>
        </fix>
        <fix name="Gamma_s3">
          <comp dof="x"/>
          <comp dof="y"/>
          <comp dof="z"/>
        </fix>
      </bcsAndLoads>
      <!-- do not need to store results for displ-->
    </mechanic>

    <electrostatic>
      <regionList>
        <region name="Patch1"/>
        <region name="Patch2" />
        <region name="Patch3" />
      </regionList>
      <bcsAndLoads>
        <constraint name="Patch1_Sdown" /> <!-- Same Potential all over the electrodes-->
        <constraint name="Patch2_Sdown" />
        <ground name="Patch3_Sdown" />

        <constraint name="Patch1_Sup" /> 
        <constraint name="Patch2_Sup" />
        <potential name="Patch3_Sup" harmonic="500" /> <!-- Apply periodic voltage = Potential difference on Path3-->
     </bcsAndLoads>
      <storeResults>
        <nodeResult type="elecPotential">
          <regionList>
            <region name="Patch1_Sup" />
            <region name="Patch2_Sup" />
            <region name="Patch1_Sdown" />
            <region name="Patch2_Sdown" />
          </regionList>
        </nodeResult>
      </storeResults>
    </electrostatic>
  </pdeList>

  <couplingList>
    <direct>
      <piezoDirect>
        <regionList>
          <!-- Regions for piezo coupling-->
          <region name="Patch1"/>
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>
      </piezoDirect>
    </direct>
  </couplingList>
</sequenceStep>

 <!-- Transient analysis in sequenceStep 4 -->
  <sequenceStep index="5">

  <analysis>
    <transient>
      <numSteps> 1500 </numSteps>
      <deltaT> 0.000333333 </deltaT><!-- = 0.5 / 1500 -->
    </transient>
  </analysis>

    <pdeList>
      <mechanic subType="3d">
        <regionList>
          <region name="Plate_PMMA" dampingId="rayleigh_damping"/>
          <region name="Patch1" />
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>

        <dampingList>
          <rayleigh id="rayleigh_damping">
          </rayleigh>
        </dampingList>

        <!-- Use result from another sequenceStep as initial state of the transient simulation -->
        <initialValues>
          <initialState>
            <sequenceStep index="1"/> <!-- use static-->
          </initialState>
        </initialValues>

        <bcsAndLoads>
          <fix name="Gamma_s1">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s2">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
          <fix name="Gamma_s3">
            <comp dof="x"/>
            <comp dof="y"/>
            <comp dof="z"/>
          </fix>
        </bcsAndLoads>
        <storeResults>
          <nodeResult type="mechDisplacement">
            <nodeList>
              <nodes name="P_middle" />
            </nodeList>
          </nodeResult>
        </storeResults>
      </mechanic>

      <electrostatic>
        <regionList>
          <region name="Patch1"/>
          <region name="Patch2" />
          <region name="Patch3" />
        </regionList>
        <bcsAndLoads>
          <constraint name="Patch1_Sdown" /> <!-- Same Potential all over the electrodes-->
          <constraint name="Patch2_Sdown" />
          <constraint name="Patch3_Sdown" />
  
          <constraint name="Patch1_Sup" /> 
          <constraint name="Patch2_Sup" />
          <constraint name="Patch3_Sup" />
        </bcsAndLoads>
        <storeResults>
          <nodeResult type="elecPotential">
            <regionList>
              <region name="Patch1_Sdown" />
              <region name="Patch1_sup" /> <!-- voltage at patch 1-->
            </regionList>
          </nodeResult>
        </storeResults>
      </electrostatic>
    </pdeList>

    <couplingList>
      <direct>
        <piezoDirect>
          <regionList>
            <!-- Regions for piezo coupling-->
            <region name="Patch1"/>
            <region name="Patch2" />
            <region name="Patch3" />
          </regionList>
        </piezoDirect>
      </direct>
    </couplingList>
  </sequenceStep>
</cfsSimulation>
